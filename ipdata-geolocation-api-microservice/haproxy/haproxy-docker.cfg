global
    log stdout local0
    log stdout local1 notice
    maxconn 4096
    daemon

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    option  forwardfor
    option  http-server-close
    timeout connect 10s
    timeout client  600s
    timeout server  600s
    timeout http-keep-alive 60s
    timeout http-request 310s
    retries 3
    
    # Error pages
    errorfile 400 /usr/local/etc/haproxy/errors/400.http
    errorfile 403 /usr/local/etc/haproxy/errors/403.http
    errorfile 408 /usr/local/etc/haproxy/errors/408.http
    errorfile 500 /usr/local/etc/haproxy/errors/500.http
    errorfile 502 /usr/local/etc/haproxy/errors/502.http
    errorfile 503 /usr/local/etc/haproxy/errors/503.http
    errorfile 504 /usr/local/etc/haproxy/errors/504.http

# Stats endpoint
frontend stats
    mode http
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 10s
    stats admin if TRUE

# Main frontend pentru API
frontend ipdata_frontend
    bind *:80
    mode http
    maxconn 2000
    
    # Rate limiting headers
    http-request set-header X-Forwarded-For %[src]
    http-request set-header X-Real-IP %[src]
    
    # Logging
    capture request header Host len 32
    capture request header X-Forwarded-For len 15
    
    default_backend ipdata_backend

# Backend cu toate instan»õele
backend ipdata_backend
    mode http
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    
    # Docker network containers
    server ipdata-1 ipdata-1:80 check inter 5s rise 2 fall 3 maxconn 200
    server ipdata-2 ipdata-2:80 check inter 5s rise 2 fall 3 maxconn 200
    server ipdata-3 ipdata-3:80 check inter 5s rise 2 fall 3 maxconn 200
    server ipdata-4 ipdata-4:80 check inter 5s rise 2 fall 3 maxconn 200
    server ipdata-5 ipdata-5:80 check inter 5s rise 2 fall 3 maxconn 200
    server ipdata-6 ipdata-6:80 check inter 5s rise 2 fall 3 maxconn 200
    server ipdata-7 ipdata-7:80 check inter 5s rise 2 fall 3 maxconn 200
    server ipdata-8 ipdata-8:80 check inter 5s rise 2 fall 3 maxconn 200
    server ipdata-9 ipdata-9:80 check inter 5s rise 2 fall 3 maxconn 200
    server ipdata-10 ipdata-10:80 check inter 5s rise 2 fall 3 maxconn 200
