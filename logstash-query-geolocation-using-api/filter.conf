filter {

  if [ipaddr] or [client_ip] {

       mutate {
              rename => { "client_ip" => "ipaddr" }
       }

    elasticsearch {
      hosts => [ "https://ELASTICSEARCH_HOST_1:9200", "https://ELASTICSEARCH_HOST_2:9200", "https://ELASTICSEARCH_HOST_3:9200" ]
      index => "ipdata-*"
      query => "ip:%{[ipaddr]}"
      ssl_certificate_authorities => "/etc/logstash/certs/ca.crt"
      password => "ELASTICSEARCH_PASSWORD"
      user => "elastic"
      fields => {
        "ip" => "[geoip][ip]"
        "asn" => "[geoip][asn]"
        "country_code" => "[geoip][country_code]"
        "country_name" => "[geoip][country_name]"
        "city" => "[geoip][city]"
        "continent_code" => "[geoip][continent_code]"
        "region" => "[geoip][region]"
        "is_eu" => "[geoip][is_eu]"
        "threat" => "[geoip][threat]"
      }
    } #end elasticsearch

    if ![geoip][ip] {

      http {
        url => "http://IPDATA_SERVICE_HOST:8000/ip/%{[ipaddr]}"
        verb => "GET"
        target_body => "ipdata"
      }

      if [ipdata] =~ /{"message":"Request limit exceeded for IPData API"}/ {
         mutate {
            add_tag => ["request_limit_exceeded"]
        }
      }

      if "request_limit_exceeded" not in [tags] {

        mutate {
         gsub => [
               "ipdata", "\n", "",  # Elimină orice caractere newline
              "ipdata", "\r", ""   # Elimină orice caractere carriage return
         ] 
         add_field => {
            "[geoip][ip]" => "%{[ipdata][data][ip]}"
            "[geoip][asn][asn]" => "%{[ipdata][data][asn][asn]}"
            "[geoip][asn][name]" => "%{[ipdata][data][asn][name]}"
            "[geoip][asn][domain]" => "%{[ipdata][data][asn][domain]}"
            "[geoip][asn][route]" => "%{[ipdata][data][asn][route]}"
            "[geoip][asn][type]" => "%{[ipdata][data][asn][type]}"
            "[geoip][country_code]" => "%{[ipdata][data][country_code]}"
            "[geoip][country_name]" => "%{[ipdata][data][country_name]}"
            "[geoip][city]" => "%{[ipdata][data][city]}"
            "[geoip][region]" => "%{[ipdata][data][region]}"
            "[geoip][continent_code]" => "%{[ipdata][data][continent_code]}"
            "[geoip][is_eu]" => "%{[ipdata][data][is_eu]}"
            "[geoip][threat][is_anonymous]" => "%{[ipdata][data][threat][is_anonymous]}"
            "[geoip][threat][is_bogon]" => "%{[ipdata][data][threat][is_bogon]}"
            "[geoip][threat][is_datacenter]" => "%{[ipdata][data][threat][is_datacenter]}"
            "[geoip][threat][is_icloud_relay]" => "%{[ipdata][data][threat][is_icloud_relay]}"
            "[geoip][threat][is_known_abuser]" => "%{[ipdata][data][threat][is_known_abuser]}"
            "[geoip][threat][is_known_attacker]" => "%{[ipdata][data][threat][is_known_attacker]}"
            "[geoip][threat][is_proxy]" => "%{[ipdata][data][threat][is_proxy]}"
            "[geoip][threat][is_threat]" => "%{[ipdata][data][threat][is_threat]}"
            "[geoip][threat][is_tor]" => "%{[ipdata][data][threat][is_tor]}"
            "[geoip][threat][is_vpn]" => "%{[ipdata][data][threat][is_vpn]}"
            "[geoip][threat][scores][proxy_score]" => "%{[ipdata][data][threat][scores][proxy_score]}"
            "[geoip][threat][scores][vpn_score]" => "%{[ipdata][data][threat][scores][vpn_score]}"
            "[geoip][threat][scores][threat_score]" => "%{[ipdata][data][threat][scores][threat_score]}"
            "[geoip][threat][scores][trust_score]" => "%{[ipdata][data][threat][scores][trust_score]}"
         }
        } #end mutate

      } #end request_limit_exceeded
    } #end ! [geoip][ip]

        mutate {
          remove_field => ["ipdata"]
       }

  } #end if ipaddr or client_ip


  if [geoip][is_eu] == "null" {
            mutate {
                add_tag => ["is_eu_null","blacklist"]
            }
  } 
  ruby {
    code => "
      is_eu = event.get('[ipdata][data][is_eu]')
      if is_eu == 'null'  # Verifică dacă valoarea este string-ul 'null'
        event.set('[geoip][is_eu]', false)
      else
        event.set('[geoip][is_eu]', is_eu)
      end
    "
  }

}
